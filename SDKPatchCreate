#!/bin/bash

set -euo pipefail

realpath() {
  OURPWD=$PWD
  cd "$(dirname "$1")"
  LINK=$(readlink "$(basename "$1")" || true)
  while [ "$LINK" ]; do
    cd "$(dirname "$LINK")"
    LINK=$(readlink "$(basename "$1")" || true)
  done
  REALPATH="$PWD/$(basename "$1")"
  cd "$OURPWD"
  echo "$REALPATH"
}

root="$( realpath $(dirname "${BASH_SOURCE[0]}") )"
. "$root/versions.sh"

cd "$root/../toolchains/nRF5"

# Create Mesh SDK patch
mesh_dir="nrf5SDKforMeshv${NRF5_MESH_SDK_VERSION}src"
diff -Naur \
  -x *.DS_Store -x *.elf -x *.hex -x *.map -x *.o -x *.bin -x _build -x Output -x *.emSession \
  "${mesh_dir}.orig" "${mesh_dir}" > "$root/sdk/${mesh_dir}.patch" || true

# Create main SDK patch limited to components/toolchain/gcc/Makefile.common
. "$root/versions.sh"
sdk_version="$NRF5_SDK_VERSION"
if [[ -n "${sdk_version:-}" ]]; then
  sdk_dir="${sdk_version}"
  sdk_dir_orig="${sdk_version}_vanilla"
  target_rel="components/toolchain/gcc/Makefile.common"
  if [[ -f "$sdk_dir/$target_rel" && -f "$sdk_dir_orig/$target_rel" ]]; then
    tmp_patch="$root/sdk/${sdk_version}.patch.tmp"
    out_patch="$root/sdk/${sdk_version}.patch"
    # Create unified diff for the single file
    diff -u "$sdk_dir_orig/$target_rel" "$sdk_dir/$target_rel" > "$tmp_patch" || true
    if [[ -s "$tmp_patch" ]]; then
      # Rewrite headers to a/ b/ paths so git apply works from SDK root
      sed -E \
        -e 's|^--- .*components/toolchain/gcc/Makefile\.common$|--- a/components/toolchain/gcc/Makefile.common|' \
        -e 's|^\+\+\+ .*components/toolchain/gcc/Makefile\.common$|+++ b/components/toolchain/gcc/Makefile.common|' \
        "$tmp_patch" > "$out_patch"
      rm -f "$tmp_patch"
      echo "Wrote main SDK patch: $out_patch"
    else
      rm -f "$tmp_patch"
      echo "No changes detected for $target_rel; main SDK patch not created."
    fi
  else
    echo "Skipping main SDK patch: $sdk_dir_orig/$target_rel or $sdk_dir/$target_rel not found" >&2
  fi
else
  echo "Could not determine nRF5 SDK version from $cmake_file; skipping main SDK patch" >&2
fi

echo "Done!"
